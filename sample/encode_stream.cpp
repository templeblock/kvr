//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

#include "streams.h"

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

void sample_encode_stream ()
{
  // create a kvr context
  kvr::ctx *ctx = kvr::ctx::create ();

  // create a map and transcode from a json file to a msgpack file
  kvr::value *val0 = ctx->create_value ();
  {
    file_istream<1024> iarnx ("data/ARN-x.json");
    if (val0->decode (kvr::CODEC_JSON, iarnx))
    {
      printf ("%s\n", "decoded ARN-x.json");
      file_ostream<1024> oarnx ("data/ARN-x.msgpack");
      if (val0->encode (kvr::CODEC_MSGPACK, &oarnx))
      {
        printf ("%s\n", "encoded ARN-x.msgpack");
      }
      oarnx.close ();
    }
    iarnx.close ();
  }

  // let's transcode again but this time the reverse (msgpack back to json)
  kvr::value *val1 = ctx->create_value ();
  {
    zero_copy_file_istream iarnx ("data/ARN-x.msgpack");
    if (val1->decode (kvr::CODEC_MSGPACK, iarnx))
    {
      printf ("%s\n", "decoded ARN-x.msgpack");
      zero_copy_file_ostream oarnx ("data/ARN-x.2.json");
      if (val1->encode (kvr::CODEC_JSON, &oarnx))
      {
        printf ("%s\n", "encoded ARN-x.2.json");
      }
      oarnx.close ();
    }
    iarnx.close ();
  }

  // clean up
  ctx->destroy_value (val0);
  ctx->destroy_value (val1);

  // destroy context
  kvr::ctx::destroy (ctx);
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

int main ()
{
  sample_encode_stream ();

  return 0;
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
